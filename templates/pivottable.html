{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <link rel="stylesheet" href="{% static './stylesheet.css' %}" type="text/css"/> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="{% static 'script.js' %}"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <style>
        .container{
       display:grid;
      grid-template-rows:8vh 10vh 72vh 10vh;
      grid-template-columns:300px auto;
       grid-template-areas: 
       "one two two two"
       "one three three three"
       "one four four four "
       "one five five five";
       gap:10px;
   }
   .one{grid-area: one;}
   .two{grid-area: two;}
   .three{grid-area: three;}
   .four{grid-area: four;}
   .five{grid-area: five;}
  
   </style>
</head>
<body>

<div class="container">
    <div class="one">
        <div id="mySidenav" class="sidenav">
        <a href="#">
            <i class="fa fa-home" aria-hidden="true"style="font-size: 30px;position:relative;top:150px;"></i>
            <h2 style="display: inline; margin-left: 5px;position:relative;top:150px;">HOME</h2>
        </a>
        <P><a class="links" href="{% url 'rbinewhome' %}">   Probe Agile Data</a></p>
		<span><a class="links" href="{% url 'table_details2' %}"> Market Data  </a></span>
        <p class="logo"><span> Data sources</span></p><hr>
       
        {% for table_name in table_names %}
            <a href="{% url 'table_details' table_name %}?table_names={{ table_names|join:',' }}" style="font-weight: bold;">
                <i class="fa fa-list icons">&nbsp;{{ table_name }}</i></a>
        {% endfor %}
       </div>
    </div>


        <div class="two">
            <div class="col-div-6">
                <span style="font-size:30px;cursor:pointer; color: #f7403b;" class="nav">  Data Extraction Status for Market Data Sources </span>
            </div>
        </div>
            
        <div class="three">
                <div class="box">
                     <p> Metrics from "{{ yesterday|date:"d-m-Y" }}"  to "{{ start_date|date:"d-m-Y" }}"</P>
                </div>
        </div>
     

        
    
<div class="four">
     <div class="content-box">
        <title>All Table Details</title>
            {% if structured_data %}
    <div class="card">
        <div style="display: flex;">
        <div class="left" style="flex: 1;">
            <table>
                <thead><tr> <td rowspan="2" style="text-align: center; padding: 29px; color: #6408f7; font-size: 16px; font-weight: bold; text-transform: capitalize;width: 150px;">
                    Data source
                  </td></tr></thead>
              <tbody>
                <tr><td style="text-align: left;"><a href="#" onclick="openPopup('ace_company_master');"> ace_company_master </a></td></tr>
                <tr><td style="text-align: left;"><a href="#" onclick="openPopup('bse_new_equity');"> bse_new_equity </a></td></tr>
                <tr><td style="text-align: left;"><a href="#" onclick="openPopup('ace_company_equity');">ace_company_equity </a></td></tr>
                <tr><td style="text-align: left;"><a href="#" onclick="openPopup('ace_company_equity_cons');">ace_company_equity_cons </a></td></tr>
                <tr><td style="text-align: left;"><a href="#" onclick="openPopup('ace_52whl');"> ace_52whl </a></td></tr>
                <tr><td style="text-align: left;"><a href="#" onclick="openPopup('bse_market_capital');">bse_market_capital </a></td></tr>
                <tr><td style="text-align: left;"><a href="#" onclick="openPopup('bse_financial_PROV');">bse_financial_PROV </a></td></tr>
                <tr><td style="text-align: left;"><a href="#" onclick="openPopup('bse_financial_QC');"> bse_financial_QC </a></td></tr>
                <tr><td style="text-align: left;"><a href="#" onclick="openPopup('ace_finance_Quarterly');"> ace_finance_Quarterly </a></td></tr>
                <tr><td style="text-align: left;"><a href="#" onclick="openPopup('ace_finance_Quarterly_Cons');">ace_finance_Quarterly_Cons </a></td></tr>
                <tr><td style="text-align: left;"><a href="#" onclick="openPopup('ace_Finance_cf');">ace_Finance_cf </a></td></tr>
                <tr><td style="text-align: left;"><a href="#" onclick="openPopup('ace_Finance_cons_cf');"> ace_Finance_cons_cf </a></td></tr>
                <tr><td style="text-align: left;"><a href="#" onclick="openPopup('ace_Finance_fr');">ace_Finance_fr </a></td></tr>
                <tr><td style="text-align: left;"><a href="#" onclick="openPopup('Capitaline_standalone');"> Capitaline_standalone</a></td></tr>
                <tr><td style="text-align: left;"><a href="#" onclick="openPopup('Capitaline_consolidated');">Capitaline_consolidated </a></td></tr>
                <tr><td style="text-align: left;"><a href="#" onclick="openPopup('bse_pledge');">bse_pledge </a></td></tr>
                <tr><td style="text-align: left;"><a href="#" onclick="openPopup('nse_pledge_new');">nse_pledge_new </a></td></tr>
                <tr><td style="text-align: left;"><a href="#" onclick="openPopup('bse_shp');"> bse_shp</a></td></tr>
                <tr><td style="text-align: left;"><a href="#" onclick="openPopup('ace_shp');"> ace_shp </a></td></tr>
              </tbody>
            </table>
          </div>
          <table>

            <thead>
                <tr> <td rowspan="2" style="text-align: center; padding: 29px; color: #6408f7; font-size: 16px; font-weight: bold; text-transform: capitalize;width: 150px;">
                    #Records
                  </td></tr>
            </thead>
            <tbody>
                {% for table_name, date_data in structured_data.items %}
                    <tr>
                        {% for date, entry in date_data.items %}
                            {% if forloop.counter == 1 %} {# Only display for the first day #}
                                <td style= "color: #6408f7; font-weight:400px;font-size: 15px;">
                                    {% if entry.total_record_count %}
                                        {{ entry.total_record_count }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
          </table>
        <table>
            <thead>
                <tr>
                    {% for date in date_range %}
                        <th colspan="2" style="text-align: center;">{{ date|date:"d-m-Y" }}</th>
                    {% endfor %}
                </tr>
                <tr>
                    {% for date in date_range %}
                        <th>Available</th>
                        <th>Scraped</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for table_name, date_data in structured_data.items %}
                    <tr>
                        {% for date, entry in date_data.items %}
                            <td>
                                {% if entry.no_of_data_available %}
                                    {{ entry.no_of_data_available }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td style="padding: 5px;">
                                <span style="color: {% if entry.status|lower == 'success' %} green {% elif entry.status == 'failure' and table_name in amber_table_names %} orange {% else %} red {% endif %}">
                                    {% if entry.no_of_data_scraped %}
                                        {{ entry.no_of_data_scraped }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </span>
                            </td>                            
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <p> select a valid date range </p>
{% endif %}
</div>
</div> 
</div>


        
	

      <div class="five">
			<div class="col-div-4" style="text-align:center;">
                <div style="text-align: center;">
				<p style="color: red;font-size:21px;"> Contact us for support : <a href="mailto:agiledatahelp@gmail.com" target="_blank" rel="noopener noreferrer" style="color: red;font-size:21px;">agiledatahelp@gmail.com</a></p>
			</div>
		</div>
    </div>
     
</div>


	

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script>
		
		// When the user clicks on <div>, open the popup
			function toggleDateInputs() {
				var timeRangeSelect = document.getElementById('time_range_select');
				var dateRangeForm = document.getElementById('date_range_form');
				var filterButton = document.querySelector("#date_range_form button");

                if (timeRangeSelect.value === "custom") {
                    var currentDate = new Date();
                    var ninetyDaysAgo = new Date();
                    ninetyDaysAgo.setDate(currentDate.getDate() - 90);
            
                    // Enable or disable the "Date Range" option based on the restriction
                    var dateRangeOption = document.querySelector("option[value='custom']");
                    dateRangeOption.disabled = (ninetyDaysAgo > new Date());
            
                    dateRangeForm.style.display = "inline-block";
                    filterButton.style.display = "inline-block";
                } else {
                    dateRangeForm.style.display = "none";
                    filterButton.style.display = "none";
                }
            }


           

			// Function to set the from_date and to_date values based on the selected time range
			function setDefaultDates() {
				var timeRangeSelect = document.getElementById('time_range_select');
				var fromInput = document.getElementById('from_date');
				var toInput = document.getElementById('to_date');
				
				if (timeRangeSelect.value === '7') {
					// Set the from_date to 15 days ago and to_date to today
					var sevenDaysAgo = new Date();
					sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
					fromInput.value = sevenDaysAgo.toISOString().split('T')[0];
		
					var today = new Date();
					toInput.value = today.toISOString().split('T')[0];
				} else if (timeRangeSelect.value === '15') {
					// Set the from_date to 15 days ago and to_date to today
					var fifteenDaysAgo = new Date();
					fifteenDaysAgo.setDate(fifteenDaysAgo.getDate() - 15);
					fromInput.value = fifteenDaysAgo.toISOString().split('T')[0];
		
					var today = new Date();
					toInput.value = today.toISOString().split('T')[0];
				} else if (timeRangeSelect.value === '30') {
					// Set the from_date to 30 days ago and to_date to today
					var thirtyDaysAgo = new Date();
					thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
					fromInput.value = thirtyDaysAgo.toISOString().split('T')[0];
		
					var today = new Date();
					toInput.value = today.toISOString().split('T')[0];
				}
			}
			function submitForm() {
				document.getElementById('date_range_form').submit();
			}
			$(document).ready(function () {
				// Set the default time range to "Last 7 Days"
				$("#time_range_select").val("7");
		
				// Call the function to toggle date inputs based on the default selection
				toggleDateInputs();
		
				// Call the function to set default dates based on the default time range
				setDefaultDates();

                highlightSelectedTable();
			});
            function openPopup(table_name) {
                $.ajax({
                    url: `/get_data_for_popup/${table_name}/`,
                    method: 'GET',
                    success: function(data) {
                        console.log(data.reason);  
                        if (data) {
                            var popupContent = `
                                <div class="popup-container">
                                    <span class="close-btn" onclick="closePopup()">X</span>
                                    <p class="popup-info">Data Source :   <span class="popup-style"> ${data.table_name}</span></p>
                                    <p class="popup-info">Status :
                                        <span class="popup-style" style="color: ${
                                            data.status.toLowerCase() === 'success' ? 'green' :
                                            (data.status.toLowerCase() === 'failure' && data.amber_table_names.includes(data.table_name)) ? 'orange' :
                                            'red'
                                        }">${data.status}</span>
                                    </p>
                                    <p class="popup-info">#Records Scraped : <span class="popup-style">${data.no_of_data_scraped}</span></p>
                                    <p class="popup-info">Failure Reason : <span class="popup-style">${data.reason ? data.reason : '-'}</span></p>
                                    <p class="popup-info">Trade Date :  <span class="popup-style">${data.trade_date}</span></p>
                                    <p class="popup-info">Scraped On :  <span class="popup-style">${data.Scraped_on}</span></p>
                                </div>
                            `;
                            $('body').append(popupContent);
            
                            $('.popup-container').fadeIn();
                        } else {
                            alert('Data not available for today.');
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Failed to fetch data for the table.');
                    }
                });
            }
        
            function closePopup() {
                $('.popup-container').fadeOut(function() {
                    $(this).remove();
                });
            }
            
            function highlightSelectedTable() {
                var selectedTable = "{{ table_name }}";  // Assuming table_name is defined in your Django context
                var tableLinks = document.querySelectorAll('.table-link');
        
                tableLinks.forEach(function (link) {
                    if (link.textContent.trim() === selectedTable) {
                        link.classList.add('highlight');
                  // Apply styles directly
                link.style.backgroundColor = 'greenyellow';
                link.style.fontWeight = 'bold';
                // Add any other styles you want to apply
            }
        });
    }
	</script>
	</body>
	</html>